FROM dockerhub.grammarly.io/golang-1.4.2-cross:v2

REQUIRE Version

ADD . /src
WORKDIR /src


ENV CGO_ENABLED=0 GOOS=linux GOARCH=amd64

{{ if .test }}
MOUNT /var/run/docker.sock:/var/run/docker.sock
{{ if .TestArgs }}
ENV TESTARGS="{{ .TestArgs }}"
{{ end }}
ATTACH ["bash"]
RUN make test
{{ end }}

RUN \
  TIME=$(date "+%Y-%m-%d %H:%M GMT") \
  GOPATH=/src:/src/vendor \
  go build \
    -a -installsuffix cgo \
    -ldflags "-X main.Version '{{ .Version }}' -X main.GitCommit '$commit' -X main.GitBranch '$branch' -X main.BuildTime '$TIME'" \
    -v -o /bin/rocker src/cmd/rocker/main.go

EXPORT /bin/rocker

#========

FROM alpine:3.2

RUN apk --update add git bash

RUN mkdir -p /opt/rocker/bin
IMPORT rocker /opt/rocker/bin

VOLUME ["/opt/rocker/bin"]

WORKDIR /context

ENV PATH=/opt/rocker/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

CMD ["/opt/rocker/bin/rocker"]

PUSH --semver dockerhub.grammarly.io/rocker:{{ .Version }}
